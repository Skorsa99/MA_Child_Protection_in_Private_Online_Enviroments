<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Image_Verify</title>
    </head>
    <style>
        .button:hover {
            box-shadow: 0 0 14px rgba(0,0,0,0.15), 0 0 14px rgba(0,0,0,0.15), 0 0 14px rgba(0,0,0,0.15);
        }
    </style>
    <body style="padding: 30px; height: 100vh; width: 100vw; box-sizing: border-box; border: none;">
        <div style="height: 75%;">
            <img src="" alt="image-holder" id="image-holder" style="width: 100%; height: 100%; border-top-left-radius: 30px; border-top-right-radius: 30px; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; border: solid black 5px; box-sizing: border-box; object-fit: contain;">
        </div>
        <div style="height: calc(25% - 10px); margin-top: 10px; display: flex; flex-direction: column;">
            <div id="progress-holder" style="width: 100%; height: 30px; margin-bottom: 10px; border-radius: 10px; border: solid black 5px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; background: linear-gradient(90deg, #00cc66 0%, #00cc66 0%, #f0f0f0 0%, #f0f0f0 100%);">
                <div id="progress-text" style="font-weight: bold; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;">
                    0 / 0
                </div>
            </div>
            <div style="display: flex; flex-direction: row; height: calc(100% - 40px);">
                <button class="button" onclick="goBack()" style="flex-grow: 1; margin-right: 10px; height: 100%; border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-left-radius: 30px; border-bottom-right-radius: 10px; border: solid black 5px; box-sizing: border-box; background-color: darkgrey; cursor: pointer;">Arrow Left</button>
                <div style="aspect-ratio: 1 / 1; margin-right: 10px; height: 100%; display: flex; flex-direction: column;">
                    <button class="button" onclick="undoImage()" style="width: 100%; height: calc(50% - 5px); border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; border: solid black 5px; box-sizing: border-box; background-color: greenyellow; cursor: pointer;">Z</button>
                    <button class="button" onclick="deleteImage()" style="width: 100%; height: calc(50% - 5px); margin-top: 10px; border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; border: solid black 5px; box-sizing: border-box; background-color: red; cursor: pointer;">D</button>
                </div>
                <button class="button" onclick="passImage()" style="flex-grow: 1; height: 100%; border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-left-radius: 10px; border-bottom-right-radius: 30px; border: solid black 5px; box-sizing: border-box; background-color: darkgrey; cursor: pointer;">Arrow Right</button>
            </div>
        </div>
    </body>
    <script>
        let currentImage = null;

        async function loadImage(filename) {
            if (!filename) {
                document.getElementById("image-holder").src = "";
                return;
            }
            currentImage = filename;
            document.getElementById("image-holder").src = "/image/" + filename;
        }

        async function getNextImage() {
            const res = await fetch("/next");
            const data = await res.json();
            if (data.done) {
                alert("No more images.");
                loadImage(null);
            } else {
                loadImage(data.filename);
            }
            updateProgress();
        }

        async function passImage() {
            await fetch("/pass", { method: "POST" });
            getNextImage();
        }

        async function deleteImage() {
            await fetch("/delete", { method: "POST" });
            getNextImage();
        }

        async function goBack() {
            const res = await fetch("/previous", { method: "POST" });
            const data = await res.json();
            if (data.error) {
                alert(data.error);
            } else {
                loadImage(data.filename);
            }
            updateProgress();
        }

        async function undoImage() {
            const res = await fetch("/undo", { method: "POST" });
            const data = await res.json();
            if (data.error) {
                alert(data.error);
            } else {
                loadImage(data.filename);
            }
            updateProgress();
        }

        async function updateProgress() {
            try {
                const res = await fetch("/progress");
                const data = await res.json();
                const checked = Number.isFinite(data.checked) ? data.checked : 0;
                const total = Number.isFinite(data.total) ? data.total : 0;
                const percentRaw = (typeof data.percent === 'number') ? data.percent : 0;
                const percent = Math.max(0, Math.min(100, percentRaw));
                const holder = document.getElementById("progress-holder");
                const text = document.getElementById("progress-text");
                text.textContent = `${checked} / ${total}`;
                const stop = percent.toFixed(5); // high precision for a sharp edge
                holder.style.background = `linear-gradient(90deg, #00cc66 0%, #00cc66 ${stop}%, #f0f0f0 ${stop}%, #f0f0f0 100%)`;
            } catch (e) {
                // Fallback if something goes wrong
                const holder = document.getElementById("progress-holder");
                const text = document.getElementById("progress-text");
                text.textContent = `0 / 0`;
                holder.style.background = `linear-gradient(90deg, #00cc66 0%, #00cc66 0%, #f0f0f0 0%, #f0f0f0 100%)`;
            }
        }

        window.onload = () => {
            getNextImage();
            updateProgress();
        };

        window.addEventListener("keydown", (e) => {
            if (e.key === "ArrowRight") {
                passImage(); // next image
            } else if (e.key === "ArrowLeft") {
                goBack(); // previous image
            } else if (e.key.toLowerCase() === "d") {
                deleteImage(); // delete current
            } else if (e.key.toLowerCase() === "z") {
                undoImage(); // restore last deleted
            }
        });
    </script>
</html>
